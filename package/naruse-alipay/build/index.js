import{createLogger,processApis,EventBus,globalEvent,version,isEmpty}from"naruse-share";import run from"naruse-parser";const logger=createLogger("naruse-element");const NOOP=()=>{};const allowPropagetionEventNames=["onLongClick","onClick"];const randomId=e=>{let t=Date.now().toString(36);t+=Math.random().toString(36).slice(2,e);return t};const getPathById=function(t,n){const o=[];if(n.id===t)return o;if(!n.childNodes||!n.childNodes.length)return;for(let e=0;e<n.childNodes.length;e++){if(n.childNodes[e].id===t){o.push(e);return o}}for(let e=0;e<n.childNodes.length;e++){const r=getPathById(t,n.childNodes[e]);if(r){o.push(e);for(let e=0;e<r.length;e++){o.push(r[e])}return o}}};const getVnodeById=function(e,t){const n=getPathById(e,t);if(!n)return undefined;if(!n.length)return t;let o=t;n.forEach(e=>{o=o.childNodes[e]});return o};const initVnodeTree=function(e,t){const n=e;if(!e||typeof e!=="object")return{};if(!n.id)n.id=randomId(16);n.parentId=t;if(Array.isArray(n.childNodes)){n.childNodes.forEach(e=>initVnodeTree(e,n.id))}return n};const eventNameMap={tap:"onClick",longPress:"onLongClick",input:"onChange",blur:"onBlur",focus:"onFocus",load:"onLoad",change:"onChange"};const eventCenter=function(e,t){let n=false;if(!(e&&e.target&&e.target.id))return;const o=getVnodeById(e.target.id,t);if(!o)return;const{type:r}=e;const s=eventNameMap[r];if(!s){logger.warn(`${r}事件不支持`)}if(allowPropagetionEventNames.includes(s)){n=true;e.stopPropagation=()=>{n=false}}const i=o[s];if(!(i&&typeof i==="function"));else{i.call(o,e)}if(n){eventCenter({...e,target:{id:o.parentId},narusePropagetion:true},t)}};const allEvents=function e(t){eventCenter(t,this.data.node)};const miniappEventBehavior={props:{code:"",component:{}},data:{node:{}},methods:{onTap:allEvents,onLongPress:allEvents,onInputInput:allEvents,onInputBlur:allEvents,onInputFocus:allEvents,onImageLoad:allEvents,onCheckboxChange:allEvents}};class NaruseComponent{state={};constructor(e){this.props=e;this.$mounted=false;this.$updater=null}setState(e,t=NOOP){if(!this.$updater){logger.error("小程序组件未装载完毕，无法更新！");return}if(typeof e!=="object"){logger.error("setState 不支持的数据格式！",e);return}if(this.state===e)return;this.state={...this.state,...e};this.$updater.update(t)}forceUpdate(e=NOOP){if(!this.$updater){logger.error("小程序组件未装载完毕，无法更新！");return}this.$updater.update(e)}componentDidMount(){}componentDidUpdate(){}componentWillUnmount(){}render(){}}const isNaruseComponent=e=>e instanceof NaruseComponent;const vnodeSpecialMap={text(e,t){return{content:t?t[0]:""}}};const createElement=(e,t,...n)=>{if(isNaruseComponent(e.prototype))return createClassElement(e,t,n);if(typeof e==="function")return createFuncElement(e,t,n);return createBaseElement(e,t,n)};const createClassElement=(e,t,n)=>{t={...t,children:n};const o={actuator:e,props:t};return{naruseType:"naruse-element",component:o}};const createBaseElement=(e,t,n)=>{let o={};if(vnodeSpecialMap[e])o=vnodeSpecialMap[e](t,n);n=n.flat&&n.flat(1)||n;n=n.map(e=>{if(typeof e==="string"||typeof e==="number")return{naruseType:"text",content:e};return e});const r={naruseType:e,...t,childNodes:n,...o};return r};const createFuncElement=(e,t,n)=>{return e({...t,children:n})};const propsEquals=(t,n)=>{if(Object.is(t,n)&&typeof t!=="object"){return true}const o=Object.getOwnPropertyNames(t);const e=Object.getOwnPropertyNames(n);if(o.length!==e.length){return false}for(let e=0;e<o.length;e++){const r=o[e];if(t[r]!==n[r]){return false}}return true};class Middware{constructor(e,t,n){this.props=n;this.component=e;this.naruseComponent=new t(n);this.naruseComponent.props=n;this.naruseComponent.$updater=this;this.fristRender=true;this.updating=false}update(n=NOOP){!this.updating&&Promise.resolve().then(()=>{this.updating=false;if(!this.naruseComponent.render){logger.error("组件必须需要一个render函数");return}const e=this.naruseComponent.render();const t=initVnodeTree(e);this.component.setData({node:t},()=>{this.onUpdated();n()})});this.updating=true}onUpdated(){const e=this.fristRender?"componentDidMount":"componentDidUpdate";this.naruseComponent[e]&&this.naruseComponent[e]();if(this.fristRender)this.naruseComponent.$mounted=true;this.fristRender=false}canUpdate(e){if(!propsEquals(e,this.props)){this.naruseComponent.props=this.props;this.update()}}onUnMount(){this.naruseComponent.componentWillUnmount();this.component=null;this.naruseComponent=null}}const apiDiff={getClipboardData:{alias:"getClipboard"},setClipboardData:{alias:"setClipboard",options:{change:[{old:"data",new:"text"}]}}};const transformMeta=(r,s)=>{let i=r;Object.keys(apiDiff).forEach(e=>{const t=apiDiff[e];if(r===e){if(t.alias){i=t.alias}if(t.options){const{change:n}=t.options;const{set:o}=t.options;if(n){n.forEach(e=>{s[e.new]=s[e.old]})}if(o){o.forEach(e=>{s[e.key]=typeof e.value==="function"?e.value(s):e.value})}}}});return{key:i,options:s}};const handleSyncApis=function e(t,n,o){if(t==="getStorageSync"){const r=o[0];if(r!=null){const s=n[t]({key:r});let e=null;if(s.hasOwnProperty("data")){e=s.data}else if(s.hasOwnProperty("APDataStorage")){e=s.APDataStorage}return e===null?"":e}return console.error("getStorageSync 传入参数错误")}if(t==="setStorageSync"){const r=o[0];const i=o[1];if(r!=null){return n[t]({key:r,data:i})}return console.error("setStorageSync 传入参数错误")}if(t==="removeStorageSync"){const r=o[0];if(r!=null){return n[t]({key:r})}return console.error("removeStorageSync 传入参数错误")}if(t==="createSelectorQuery"){const a=n[t]();a.in=function(){return a};return a}return n[t].apply(n,o)};const needPromiseApis=["getStorage","setStorage","removeStorage","clearStorage","getStorageInfo","getSystemInfo","navigateTo","navigateBack","setClipboard","getClipboard"];const syncApis=["getStorageSync","setStorageSync","removeStorageSync","clearStorageSync","getStorageInfoSync"];const qnPromiseApis=["navigateToWebPage"];const initNaruseAlipayApi=()=>{const e={};processApis(e,my,{transformMeta:transformMeta,needPromiseApis:needPromiseApis,handleSyncApis:handleSyncApis,needSyncApis:syncApis});processApis(e,my.qn,{needPromiseApis:qnPromiseApis});return e};const pageCenter={};const getPageInstance=e=>{if(!e){logger.error("无效组件");return}const t=e.$page&&e.$page.$id;if(!t){logger.error("无效页面id");return}if(!pageCenter[t]){pageCenter[t]=new Page(e.$page);return pageCenter[t]}return pageCenter[t]};class Page{constructor(e){this.miniPage=e;this.eventCenter=new EventBus;this.oldEvents={};this.interceptEvent("onShow");this.interceptEvent("onHide");this.interceptEvent("onUnload");this.interceptEvent("onPullDownRefresh");this.interceptEvent("onPageScroll")}interceptEvent(e){const t=this;t.oldEvents[e]=t.miniPage[e];const n=t.miniPage[e];t.eventCenter.on(e,(...e)=>typeof n==="function"&&n.apply(this.miniPage,e));Object.defineProperty(this.miniPage,e,{get(){return()=>t.eventCenter.emit(e)},set(){logger.error("正在修改页面事件，请勿修改，请使用Naruse.Page.on()")},enumerable:true,configurable:true})}on(e,t){this.eventCenter.on(e,t)}off(e,t){this.eventCenter.off(e,t)}get route(){return this.miniPage.route}clear(){this.eventCenter.clear();Object.keys(this.oldEvents).forEach(e=>{this.miniPage[e]=this.oldEvents[e]});this.miniPage=null;this.oldEvents={}}}const withPage=n=>{return class extends NaruseComponent{render(){const e=getPageInstance(this.$updater&&this.$updater.component);const t={route:e.route,events:{on:e.on.bind(e),off:e.off.bind(e)}};return createElement(n,{...this.props,currentPage:t})}}};const apis=initNaruseAlipayApi();const Naruse={Component:NaruseComponent,globalEvent:globalEvent,EventBus:EventBus,env:{clientName:"alipay",clientVersion:version,language:"zh-Hans",platform:"alipay"},version:version,...my,...apis,withPage:withPage};my.Naruse=Naruse;const initChildComponent=function(e={}){const{actuator:t,props:n}=e;if(t){this.$middware=new Middware(this,t,n||{});this.$middware.update()}};const initMainComponent=function(){if(this.props.code===this.code)return;this.code=this.props.code;const t=this.$page.requireList||{};let o={};try{o=run(this.props.code,{h:createElement,Naruse:Naruse,my:my,...t})}catch(e){logger.error("运行时出错，自动继续",e);t.$adImport&&t.$adImport.callback&&t.$adImport.callback(true);return}let e=null;if(o.default){e=o.default}else{const n=function e(...t){const n=this;NaruseComponent.apply(this,t);o.constructor&&o.constructor.call(this);Object.entries(o).forEach(([e,t])=>{if(e==="constructor")return;n[e]=typeof t==="function"?t.bind(n):t})};n.prototype=Object.create(NaruseComponent.prototype);Object.assign(n.prototype,{constructor:n});e=n}this.$middware=new Middware(this,e,{});this.$middware.update()};const createVmContext=function(){if(!isEmpty(this.props.component)){initChildComponent.call(this,this.props.component);return}initMainComponent.call(this)};const createBehavior=(t={})=>{const e={...miniappEventBehavior,didMount(){this.option=t;try{const{onGetData:e}=this.props;if(e&&typeof e==="function"){this.props={...this.props,...e()}}createVmContext.call(this)}catch(e){logger.error("初始化失败",e)}},didUpdate(e){const{onGetData:t}=this.props;if(t&&typeof t==="function"){this.props={...this.props,...t()}}if(!isEmpty(this.props.component)){const{props:n,actuator:o}=e.component;if(o===this.props.component.actuator){this.$middware.props=this.props.component.props;this.$middware.canUpdate(n)}else{this.$middware.onUnMount();initChildComponent.call(this,this.props.component)}}},didUnmount(){this.$middware.onUnMount()}};return e};Component({mixins:[createBehavior()]});
