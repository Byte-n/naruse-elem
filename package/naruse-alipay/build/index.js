import{createLogger,processApis,EventBus,globalEvent,version,isEmpty}from"naruse-share";import run from"naruse-parser";function ownKeys(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),r.push.apply(r,n)}return r}function _objectSpread2(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?ownKeys(Object(r),!0).forEach(function(e){_defineProperty(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):ownKeys(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}function _typeof(e){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t)){throw new TypeError("Cannot call a class as a function")}}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||false;n.configurable=true;if("value"in n)n.writable=true;Object.defineProperty(e,n.key,n)}}function _createClass(e,t,r){if(t)_defineProperties(e.prototype,t);if(r)_defineProperties(e,r);Object.defineProperty(e,"prototype",{writable:false});return e}function _defineProperty(e,t,r){if(t in e){Object.defineProperty(e,t,{value:r,enumerable:true,configurable:true,writable:true})}else{e[t]=r}return e}function _inherits(e,t){if(typeof t!=="function"&&t!==null){throw new TypeError("Super expression must either be null or a function")}e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:true,configurable:true}});Object.defineProperty(e,"prototype",{writable:false});if(t)_setPrototypeOf(e,t)}function _getPrototypeOf(e){_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function e(t){return t.__proto__||Object.getPrototypeOf(t)};return _getPrototypeOf(e)}function _setPrototypeOf(e,t){_setPrototypeOf=Object.setPrototypeOf||function e(t,r){t.__proto__=r;return t};return _setPrototypeOf(e,t)}function _isNativeReflectConstruct(){if(typeof Reflect==="undefined"||!Reflect.construct)return false;if(Reflect.construct.sham)return false;if(typeof Proxy==="function")return true;try{Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}));return true}catch(e){return false}}function _assertThisInitialized(e){if(e===void 0){throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}return e}function _possibleConstructorReturn(e,t){if(t&&(typeof t==="object"||typeof t==="function")){return t}else if(t!==void 0){throw new TypeError("Derived constructors may only return object or undefined")}return _assertThisInitialized(e)}function _createSuper(o){var a=_isNativeReflectConstruct();return function e(){var t=_getPrototypeOf(o),r;if(a){var n=_getPrototypeOf(this).constructor;r=Reflect.construct(t,arguments,n)}else{r=t.apply(this,arguments)}return _possibleConstructorReturn(this,r)}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArrayLimit(e,t){var r=e==null?null:typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(r==null)return;var n=[];var o=true;var a=false;var i,s;try{for(r=r.call(e);!(o=(i=r.next()).done);o=true){n.push(i.value);if(t&&n.length===t)break}}catch(e){a=true;s=e}finally{try{if(!o&&r["return"]!=null)r["return"]()}finally{if(a)throw s}}return n}function _unsupportedIterableToArray(e,t){if(!e)return;if(typeof e==="string")return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);if(r==="Object"&&e.constructor)r=e.constructor.name;if(r==="Map"||r==="Set")return Array.from(e);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return _arrayLikeToArray(e,t)}function _arrayLikeToArray(e,t){if(t==null||t>e.length)t=e.length;for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var logger=createLogger("naruse-element");var NOOP=function e(){};var allowPropagetionEventNames=["onLongClick","onClick"];var randomId=function e(t){var r=Date.now().toString(36);r+=Math.random().toString(36).slice(2,t);return r};var getPathById=function e(t,r){var n=[];if(r.id===t)return n;if(!r.childNodes||!r.childNodes.length)return;for(var o=0;o<r.childNodes.length;o++){if(r.childNodes[o].id===t){n.push(o);return n}}for(var a=0;a<r.childNodes.length;a++){var i=e(t,r.childNodes[a]);if(i){n.push(a);for(var s=0;s<i.length;s++){n.push(i[s])}return n}}};var getVnodeById=function e(t,r){var n=getPathById(t,r);if(!n)return undefined;if(!n.length)return r;var o=r;n.forEach(function(e){o=o.childNodes[e]});return o};var initVnodeTree=function t(e,r){var n=e;if(!e||_typeof(e)!=="object")return{};if(!n.id)n.id=randomId(16);n.parentId=r;if(Array.isArray(n.childNodes)){n.childNodes.forEach(function(e){return t(e,n.id)})}return n};var eventNameMap={tap:"onClick",longPress:"onLongClick",input:"onChange",blur:"onBlur",focus:"onFocus",load:"onLoad",change:"onChange"};var eventCenter=function e(t,r){var n=false;if(!(t&&t.target&&t.target.id))return;var o=getVnodeById(t.target.id,r);if(!o)return;var a=t.type;var i=eventNameMap[a];if(!i){logger.warn("".concat(a,"事件不支持"))}if(allowPropagetionEventNames.includes(i)){n=true;t.stopPropagation=function(){n=false}}var s=o[i];if(!(s&&typeof s==="function"));else{s.call(o,t)}if(n){e(_objectSpread2(_objectSpread2({},t),{},{target:{id:o.parentId},narusePropagetion:true}),r)}};var allEvents=function e(t){eventCenter(t,this.data.node)};var miniappEventBehavior={props:{code:"",component:{}},data:{node:{}},methods:{onTap:allEvents,onLongPress:allEvents,onInputInput:allEvents,onInputBlur:allEvents,onInputFocus:allEvents,onImageLoad:allEvents,onCheckboxChange:allEvents}};var NaruseComponent=function(){function t(e){_classCallCheck(this,t);this.state={};this.props=e;this.$mounted=false;this.$updater=null}_createClass(t,[{key:"setState",value:function e(t){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:NOOP;if(!this.$updater){logger.error("小程序组件未装载完毕，无法更新！");return}if(_typeof(t)!=="object"){logger.error("setState 不支持的数据格式！",t);return}if(this.state===t)return;this.state=_objectSpread2(_objectSpread2({},this.state),t);this.$updater.update(r)}},{key:"forceUpdate",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:NOOP;if(!this.$updater){logger.error("小程序组件未装载完毕，无法更新！");return}this.$updater.update(t)}},{key:"componentDidMount",value:function e(){}},{key:"componentDidUpdate",value:function e(){}},{key:"componentWillUnmount",value:function e(){}},{key:"render",value:function e(){}}]);return t}();var isNaruseComponent=function e(t){return t instanceof NaruseComponent};var vnodeSpecialMap={text:function e(t,r){return{content:r?r[0]:""}}};var createElement=function e(t,r){for(var n=arguments.length,o=new Array(n>2?n-2:0),a=2;a<n;a++){o[a-2]=arguments[a]}if(isNaruseComponent(t.prototype))return createClassElement(t,r,o);if(typeof t==="function")return createFuncElement(t,r,o);return createBaseElement(t,r,o)};var createClassElement=function e(t,r,n){r=_objectSpread2(_objectSpread2({},r),{},{children:n});var o={actuator:t,props:r};return{naruseType:"naruse-element",component:o}};var createBaseElement=function e(t,r,n){var o={};if(vnodeSpecialMap[t])o=vnodeSpecialMap[t](r,n);n=n.flat&&n.flat(1)||n;n=n.map(function(e){if(typeof e==="string"||typeof e==="number")return{naruseType:"text",content:e};return e});var a=_objectSpread2(_objectSpread2({naruseType:t},r),{},{childNodes:n},o);return a};var createFuncElement=function e(t,r,n){return t(_objectSpread2(_objectSpread2({},r),{},{children:n}))};var propsEquals=function e(t,r){if(Object.is(t,r)&&_typeof(t)!=="object"){return true}var n=Object.getOwnPropertyNames(t);var o=Object.getOwnPropertyNames(r);if(n.length!==o.length){return false}for(var a=0;a<n.length;a++){var i=n[a];if(t[i]!==r[i]){return false}}return true};var Middware=function(){function n(e,t,r){_classCallCheck(this,n);this.props=r;this.component=e;this.naruseComponent=new t(r);this.naruseComponent.props=r;this.naruseComponent.$updater=this;this.fristRender=true;this.updating=false}_createClass(n,[{key:"update",value:function e(){var r=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:NOOP;!this.updating&&Promise.resolve().then(function(){r.updating=false;if(!r.naruseComponent.render){logger.error("组件必须需要一个render函数");return}var e=r.naruseComponent.render();var t=initVnodeTree(e);r.component.setData({node:t},function(){r.onUpdated();n()})});this.updating=true}},{key:"onUpdated",value:function e(){var t=this.fristRender?"componentDidMount":"componentDidUpdate";this.naruseComponent[t]&&this.naruseComponent[t]();if(this.fristRender)this.naruseComponent.$mounted=true;this.fristRender=false}},{key:"canUpdate",value:function e(t){if(!propsEquals(t,this.props)){this.naruseComponent.props=this.props;this.update()}}},{key:"onUnMount",value:function e(){this.naruseComponent.componentWillUnmount();this.component=null;this.naruseComponent=null}}]);return n}();var apiDiff={getClipboardData:{alias:"getClipboard"},setClipboardData:{alias:"setClipboard",options:{change:[{old:"data",new:"text"}]}}};var transformMeta=function e(o,a){var i=o;Object.keys(apiDiff).forEach(function(e){var t=apiDiff[e];if(o===e){if(t.alias){i=t.alias}if(t.options){var r=t.options.change;var n=t.options.set;if(r){r.forEach(function(e){a[e["new"]]=a[e.old]})}if(n){n.forEach(function(e){a[e.key]=typeof e.value==="function"?e.value(a):e.value})}}}});return{key:i,options:a}};var handleSyncApis=function e(t,r,n){if(t==="getStorageSync"){var o=n[0];if(o!=null){var a=r[t]({key:o});var i=null;if(a.hasOwnProperty("data")){i=a.data}else if(a.hasOwnProperty("APDataStorage")){i=a.APDataStorage}return i===null?"":i}return console.error("getStorageSync 传入参数错误")}if(t==="setStorageSync"){var s=n[0];var u=n[1];if(s!=null){return r[t]({key:s,data:u})}return console.error("setStorageSync 传入参数错误")}if(t==="removeStorageSync"){var c=n[0];if(c!=null){return r[t]({key:c})}return console.error("removeStorageSync 传入参数错误")}if(t==="createSelectorQuery"){var p=r[t]();p["in"]=function(){return p};return p}return r[t].apply(r,n)};var needPromiseApis=["getStorage","setStorage","removeStorage","clearStorage","getStorageInfo","getSystemInfo","navigateTo","navigateBack","setClipboard","getClipboard"];var syncApis=["getStorageSync","setStorageSync","removeStorageSync","clearStorageSync","getStorageInfoSync"];var qnPromiseApis=["navigateToWebPage"];var initNaruseAlipayApi=function e(){var t={};processApis(t,my,{transformMeta:transformMeta,needPromiseApis:needPromiseApis,handleSyncApis:handleSyncApis,needSyncApis:syncApis});processApis(t,my.qn,{needPromiseApis:qnPromiseApis});return t};var pageCenter={};var getPageInstance=function e(t){if(!t){logger.error("无效组件");return}var r=t.$page&&t.$page.$id;if(!r){logger.error("无效页面id");return}if(!pageCenter[r]){pageCenter[r]=new Page(t.$page);return pageCenter[r]}return pageCenter[r]};var Page=function(){function t(e){_classCallCheck(this,t);this.miniPage=e;this.eventCenter=new EventBus;this.oldEvents={};this.interceptEvent("onShow");this.interceptEvent("onHide");this.interceptEvent("onUnload");this.interceptEvent("onPullDownRefresh");this.interceptEvent("onPageScroll")}_createClass(t,[{key:"interceptEvent",value:function e(t){var n=this;var r=this;r.oldEvents[t]=r.miniPage[t];var o=r.miniPage[t];r.eventCenter.on(t,function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++){t[r]=arguments[r]}return typeof o==="function"&&o.apply(n.miniPage,t)});Object.defineProperty(this.miniPage,t,{get:function e(){return function(){return r.eventCenter.emit(t)}},set:function e(){logger.error("正在修改页面事件，请勿修改，请使用Naruse.Page.on()")},enumerable:true,configurable:true})}},{key:"on",value:function e(t,r){this.eventCenter.on(t,r)}},{key:"off",value:function e(t,r){this.eventCenter.off(t,r)}},{key:"route",get:function e(){return this.miniPage.route}},{key:"clear",value:function e(){var t=this;this.eventCenter.clear();Object.keys(this.oldEvents).forEach(function(e){t.miniPage[e]=t.oldEvents[e]});this.miniPage=null;this.oldEvents={}}}]);return t}();var withPage=function e(n){return function(e){_inherits(r,e);var t=_createSuper(r);function r(){_classCallCheck(this,r);return t.apply(this,arguments)}_createClass(r,[{key:"render",value:function e(){var t=getPageInstance(this.$updater&&this.$updater.component);var r={route:t.route,events:{on:t.on.bind(t),off:t.off.bind(t)}};return createElement(n,_objectSpread2(_objectSpread2({},this.props),{},{currentPage:r}))}}]);return r}(NaruseComponent)};var apis=initNaruseAlipayApi();var Naruse=_objectSpread2(_objectSpread2(_objectSpread2({Component:NaruseComponent,globalEvent:globalEvent,EventBus:EventBus,env:{clientName:"alipay",clientVersion:version,language:"zh-Hans",platform:"alipay"},version:version},my),apis),{},{withPage:withPage});my.Naruse=Naruse;var initChildComponent=function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var r=t.actuator,n=t.props;if(r){this.$middware=new Middware(this,r,n||{});this.$middware.update()}};var initMainComponent=function e(){if(this.props.code===this.code)return;this.code=this.props.code;var t=this.$page.requireList||{};var a={};try{a=run(this.props.code,_objectSpread2({h:createElement,Naruse:Naruse,my:my},t))}catch(e){logger.error("运行时出错，自动继续",e);t.$adImport&&t.$adImport.callback&&t.$adImport.callback(true);return}var r=null;if(a["default"]){r=a["default"]}else{var n=function e(){var o=this;for(var t=arguments.length,r=new Array(t),n=0;n<t;n++){r[n]=arguments[n]}NaruseComponent.apply(this,r);a.constructor&&a.constructor.call(this);Object.entries(a).forEach(function(e){var t=_slicedToArray(e,2),r=t[0],n=t[1];if(r==="constructor")return;o[r]=typeof n==="function"?n.bind(o):n})};n.prototype=Object.create(NaruseComponent.prototype);Object.assign(n.prototype,{constructor:n});r=n}this.$middware=new Middware(this,r,{});this.$middware.update()};var createVmContext=function e(){if(!isEmpty(this.props.component)){initChildComponent.call(this,this.props.component);return}initMainComponent.call(this)};var createBehavior=function e(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var t=_objectSpread2(_objectSpread2({},miniappEventBehavior),{},{didMount:function e(){this.option=r;try{var t=this.props.onGetData;if(t&&typeof t==="function"){this.props=_objectSpread2(_objectSpread2({},this.props),t())}createVmContext.call(this)}catch(e){logger.error("初始化失败",e)}},didUpdate:function e(t){var r=this.props.onGetData;if(r&&typeof r==="function"){this.props=_objectSpread2(_objectSpread2({},this.props),r())}if(!isEmpty(this.props.component)){var n=t.component,o=n.props,a=n.actuator;if(a===this.props.component.actuator){this.$middware.props=this.props.component.props;this.$middware.canUpdate(o)}else{this.$middware.onUnMount();initChildComponent.call(this,this.props.component)}}},didUnmount:function e(){this.$middware.onUnMount()}});return t};Component({mixins:[createBehavior()]});
