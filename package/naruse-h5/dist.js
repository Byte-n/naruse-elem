import React from "react";
const _defineProperty=function(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t},_typeof=t=>typeof t,babelPolyfill={_defineProperty:_defineProperty,typeof:_typeof},types={num:"num",string:"string",name:"name",bracketL:"[",bracketR:"]",braceL:"{",braceR:"}",parenL:"(",parenR:")",comma:",",semi:";",colon:":",dot:".",question:"?",eq:"=",logicalOR:"||",logicalAND:"&&",bitwiseOR:"|",bitwiseXOR:"^",bitwiseAND:"&",plusMin:"+/-",incDec:"++/--",equality:"==/!=/===/!==",relational:"</>/<=/>=",prefix:"!/~",modulo:"%",star:"*",slash:"/",assign:"_=",_break:"break",_continue:"continue",_else:"else",_for:"for",_function:"function",_if:"if",_return:"return",_var:"var",_const:"const",_let:"let",_in:"in",_instanceof:"instanceof",_new:"new",_import:"import",_null:"null",_true:"true",_false:"false"},emptyChar=["\n","\t"," ","\r"],isEmptyChar=t=>emptyChar.includes(t),tt=types,keywords=[tt._break,tt._continue,tt._else,tt._for,tt._function,tt._if,tt._return,tt._const,tt._let,tt._null,tt._false,tt._true,tt._var,tt._in,tt._instanceof,tt._new],priority={[tt.logicalOR]:1,[tt.logicalAND]:2,[tt.bitwiseOR]:3,[tt.bitwiseAND]:5,[tt.equality]:6,[tt.relational]:7,[tt.plusMin]:9,[tt.modulo]:10,[tt.star]:10,[tt.slash]:10,[tt._in]:7,[tt._instanceof]:7};class Token{pos=0;input="";tokens=[];constructor(t){this.input=t}scan(){for(;;){const t=this.input[this.pos];if(isEmptyChar(t))this.pos++;else{if(!t)break;t.match(/[a-zA-Z_$]/)?this.readWord():this.getTokenFromCode(t.charCodeAt())}}return this.tokens}getTokenFromCode(t){switch(t){case 46:return this.readToken_dot();case 40:return++this.pos,this.ftk(tt.parenL);case 41:return++this.pos,this.ftk(tt.parenR);case 59:return++this.pos,this.ftk(tt.semi);case 63:return++this.pos,this.ftk(tt.question);case 44:return++this.pos,this.ftk(tt.comma);case 91:return++this.pos,this.ftk(tt.bracketL);case 93:return++this.pos,this.ftk(tt.bracketR);case 123:return++this.pos,this.ftk(tt.braceL);case 125:return++this.pos,this.ftk(tt.braceR);case 58:return++this.pos,this.ftk(tt.colon);case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:return this.readNumber(t);case 34:case 39:return this.readString(t);case 37:case 42:case 47:return this.readToken_mult_modulo_exp(t);case 124:case 38:return this.readToken_pipe_amp(t);case 43:case 45:return this.readToken_plus_min(t);case 60:case 62:return this.readToken_lt_gt(t);case 61:case 33:return this.readToken_eq_excl(t)}++this.pos,console.warn(this.pos,"Unexpected character '"+t+"'")}readWord(){let t="",e;for(;(e=this.input[this.pos])&&e.match(/[a-zA-Z0-9\_\$]/);)t+=e,this.pos++;let r=tt.name;return keywords.includes(t)&&(r=t),this.ftk(r,t)}readToken_lt_gt(t){var e=this.gnc();let r=1;return e===t?(r=62===t&&62===this.gnc(2)?3:2,61===this.gnc(r)?this.finishOp(tt.assign,r+1):this.finishOp(tt.bitShift,r)):(61===e&&(r=2),this.finishOp(tt.relational,r))}readNumber(t){let e=0;for(;47<t&&t<58||46===t;)e++,t=this.gnc(e);return this.finishOp(tt.num,parseFloat(e))}readString(t){var e=t;let r="";for(t=this.gnc();t!==e;)r+=this.input[++this.pos],t=this.gnc();return this.pos=this.pos+2,this.ftk(tt.string,r)}readToken_mult_modulo_exp(t){var e=this.gnc(),t=String.fromCharCode(t),t=priority[t]&&t;return 61===e?(this.pos++,this.finishOp(tt.assign,2)):this.finishOp(t,1)}finishOp(t,e){var r=this.input.substring(this.pos,this.pos+e);return this.pos+=e,this.ftk(t,r)}ftk(t,e){this.tokens.push({type:t,value:e,pos:this.pos})}readToken_pipe_amp(t){return this.gnc()===t?this.finishOp(124===t?tt.logicalOR:tt.logicalAND,2):this.finishOp(124===t?tt.bitwiseOR:tt.bitwiseAND,1)}readToken_dot(){var t=this.gnc();return 48<=t&&t<=57?this.readNumber(!0):(this.pos++,this.ftk(tt.dot))}gnc(t=1){return this.input[this.pos+t].charCodeAt()}readToken_plus_min(t){var e=this.gnc();return e===t?this.finishOp(tt.incDec,2):61===e?this.finishOp(tt.assign,2):this.finishOp(tt.plusMin,1)}readToken_eq_excl(t){return 61===this.gnc()?this.finishOp(tt.equality,61===this.gnc(2)?3:2):this.finishOp(61===t?tt.eq:tt.prefix,1)}}class Parser{tokens=[];index=-1;constructor(t){this.tokens=t}parse(){return this.nextToken(),this.parseTopLevel({body:[]})}eat(t){return this.type===t&&(this.next(),!0)}nextToken(){this.token=this.tokens[++this.index],this.type=this.token&&this.token.type,this.value=this.token&&this.token.value,this.pos=this.token&&this.token.pos}finishNode(t,e){return t.type=e,t.pos=this.pos,t}parseTopLevel(t){for(;this.type;){var e=this.parseStatement(!0);t.body.push(e)}return this.finishNode(t,"Program")}parseStatement(t){var e={};switch(this.type){case tt._break:case tt._continue:return this.parseBreakContinueStatement(e,this.value);case tt._for:return this.parseForStatement(e);case tt._function:return this.next(),this.parseFunctionStatement(e);case tt._if:return this.parseIfStatement(e);case tt._return:return this.parseReturnStatement(e);case tt._const:case tt._var:case tt._let:return this.parseVarStatement(e,this.value);case tt.braceL:return this.parseBlock(e);case tt.semi:return this.parseEmptyStatement(e);default:var r=this.parseExpression();return this.parseExpressionStatement(e,r)}}parseExpressionStatement(t,e){return t.expression=e,this.eat(tt.semi),this.finishNode(t,"ExpressionStatement")}parseEmptyStatement(t){return this.next(),this.finishNode(t,"EmptyStatement")}parseVarStatement(t,e){return this.next(),this.parseVar(t,!1,e),this.eat(tt.semi),this.finishNode(t,"VariableDeclaration")}parseVar(e,r,s){for(e.declarations=[],e.kind=s;;){let t={};if(this.parseVarId(t,s),this.eat(tt.eq)?t.init=this.parseMaybeAssign(r):t.init=null,e.declarations.push(this.finishNode(t,"VariableDeclarator")),!this.eat(tt.comma))break}return e}parseIdent(){let t={};return this.type===tt.name?t.name=this.value:this.raise("无法处理的token"),this.next(),this.finishNode(t,"Identifier")}parseMaybeAssign(e){var r=this.parseMaybeConditional(e);if(this.isAssign()){let t={};return t.operator=this.value,t.left=r,this.next(),t.right=this.parseMaybeAssign(e),this.finishNode(t,"AssignmentExpression")}return r}parseMaybeConditional(e){var r=this.parseExprOps(e);if(this.eat(tt.question)){let t={};return t.test=r,t.consequent=this.parseMaybeAssign(),this.expect(tt.colon),t.alternate=this.parseMaybeAssign(e),this.finishNode(t,"ConditionalExpression")}return r}parseExprOps(t){var e=this.parseMaybeUnary(t);return this.parseExprOp(e,-1,t)}parseExprOp(t,e,r){var s,n,i,a=priority[this.type];if(a&&!r&&e<a)return s=this.type===tt.logicalOR||this.type===tt.logicalAND,n=this.type===tt.coalesce,i=this.value,this.next(),a=this.parseExprOp(this.parseMaybeUnary(r),a,r),a=this.buildBinary(t,a,i,s||n),this.parseExprOp(a,e,r);return t}buildBinary(t,e,r,s){let n={};return n.left=t,n.operator=r,n.right=e,this.finishNode(n,s?"LogicalExpression":"BinaryExpression")}parseMaybeUnary(r){let s;if([tt.incDec,tt.prefix,tt.plusMin].includes(this.type)){let t={},e=this.type===tt.incDec;t.operator=this.value,t.prefix=!0,this.next(),t.argument=this.parseMaybeUnary(r),s=this.finishNode(t,e?"UpdateExpression":"UnaryExpression")}else for(s=this.parseExprSubscripts(r);this.type===tt.incDec;){let t={};t.operator=this.value,t.prefix=!1,t.argument=s,this.next(),s=this.finishNode(t,"UpdateExpression")}return s}parseExprSubscripts(t){var e=this.parseExprAtom(t);return this.parseSubscripts(e,!1,t)}parseSubscript(e,t){var r=this.eat(tt.bracketL);if(r||this.eat(tt.dot)){let t={};t.object=e,r?(t.property=this.parseExpression(),this.expect(tt.bracketR)):t.property=this.parseIdent(),t.computed=!!r,e=this.finishNode(t,"MemberExpression")}else if(!t&&this.eat(tt.parenL)){r=this.parseExprList(tt.parenR);let t={};t.callee=e,t.arguments=r,e=this.finishNode(t,"CallExpression")}return e}parseExpression(e){var r=this.parseMaybeAssign(e);if(this.type!==tt.comma)return r;{let t={};for(t.expressions=[r];this.eat(tt.comma);)t.expressions.push(this.parseMaybeAssign(e));return this.finishNode(t,"SequenceExpression")}}parseSubscripts(t,e){for(;;){var r=this.parseSubscript(t,e);if(r===t)return r;t=r}}parseLiteral(t){t=this.finishNode({value:(this.type===tt.string?String:parseFloat)(t)},"Literal");return this.next(),t}parseExprAtom(t){let e={};switch(this.type){case tt.name:return this.parseIdent(!1);case tt.num:case tt.string:return this.parseLiteral(this.value);case tt._null:case tt._true:case tt._false:return e.value=this.type===tt._null?null:this.type===tt._true,e.raw=this.type,this.next(),this.finishNode(e,"Literal");case tt.parenL:return this.parseParenAndDistinguishExpression(t);case tt.bracketL:return this.next(),e.elements=this.parseExprList(tt.bracketR),this.finishNode(e,"ArrayExpression");case tt.braceL:return this.parseObj(!1);case tt._function:return this.next(),this.parseFunctionStatement(e);case tt._new:return this.parseNew();default:this.raise("无法处理的token"+this.type)}}parseNew(){let t={};return this.next(),t.callee=this.parseSubscripts(this.parseExprAtom(),!0),this.eat(tt.parenL)?t.arguments=this.parseExprList(tt.parenR):t.arguments=[],this.finishNode(t,"NewExpression")}parseObj(t){let e={},r=!0;for(e.properties=[],this.next();!this.eat(tt.braceR);){r?r=!1:this.expect(tt.comma);var s=this.parseProperty(t);e.properties.push(s)}return this.finishNode(e,t?"ObjectPattern":"ObjectExpression")}parseProperty(){let t={};return t.key=this.type===tt.num||this.type===tt.string?this.parseExprAtom():this.parseIdent(),this.eat(tt.colon)?(t.value=this.parseMaybeAssign(!1),t.kind="init"):this.raise("属性名后无效属性"),this.finishNode(t,"Property")}parseParenAndDistinguishExpression(){return this.parseParenExpression()}parseVarId(t){t.id=this.parseIdent()}parseReturnStatement(t){return this.next(),this.eat(tt.semi)||this.type===tt.braceR?t.argument=null:t.argument=this.parseExpression(),this.finishNode(t,"ReturnStatement")}parseIfStatement(t){return this.next(),t.test=this.parseParenExpression(),t.consequent=this.parseStatement(),t.alternate=this.eat(tt._else)?this.parseStatement():null,this.finishNode(t,"IfStatement")}parseParenExpression(){this.expect(tt.parenL);var t=this.parseExpression();return this.expect(tt.parenR),t}parseFunctionStatement(t){return t.id=this.type!==tt.name?null:this.parseIdent(),this.parseFunctionParams(t),this.parseFunctionBody(t),this.finishNode(t,"FunctionDeclaration")}parseFunctionParams(t){this.expect(tt.parenL),t.params=this.parseBindingList(tt.parenR,!1)}parseFunctionBody(t){t.body=this.parseBlock(void 0)}parseBlock(t={}){t.body=[];for(var e=this.eat(tt.braceL);this.type&&this.type!==tt.braceR;){var r=this.parseStatement();if(t.body.push(r),!e)break}return this.next(),this.finishNode(t,"BlockStatement")}parseBindingList(t){let e=[],r=!0;for(;!this.eat(t);){r?r=!1:this.expect(tt.comma);var s=this.parseMaybeDefault();e.push(s)}return e}parseExprList(t){let e=[],r=!0;for(;!this.eat(t);)r?r=!1:this.expect(tt.comma),e.push(this.parseMaybeAssign(!1));return e}parseMaybeDefault(t){if(t=t||this.parseIdent(),!this.eat(tt.eq))return t;let e={};return e.left=t,e.right=this.parseMaybeAssign(),this.finishNode(e,"AssignmentPattern")}parseBreakContinueStatement(t,e){e="break"===e;return this.next(),this.finishNode(t,e?"BreakStatement":"ContinueStatement")}next(){this.nextToken()}parseForStatement(t){if(this.next(),this.expect(tt.parenL),this.type===tt.semi)return this.parseFor(t,null);if([tt._const,tt._var,tt._let].includes(this.type))return e={kind:this.type},this.next(),this.parseVar(e,!0,e.kind),this.finishNode(e,"VariableDeclaration"),this.parseFor(t,e);var e=this.parseExpression(!0);return this.parseFor(t,e)}isAssign(){return[tt.assign,tt.eq].includes(this.type)}raise(t){throw new Error(t)}parseFor(t,e){return t.init=e,this.expect(tt.semi),t.test=this.type===tt.semi?null:this.parseExpression(),this.expect(tt.semi),t.update=this.type===tt.parenR?null:this.parseExpression(),this.expect(tt.parenR),this.parseBlock(t),this.finishNode(t,"ForStatement")}expect(t){this.eat(t)||this.raise("unsupport type"+t)}}let anonymousId=0;const BREAK_SINGAL={},CONTINUE_SINGAL={},RETURN_SINGAL={result:void 0},evaluate_map={Program:(t,e)=>{for(const r of t.body)evaluate(r,e)},Identifier:(t,e)=>{if("undefined"!==t.name){const r=e.$find(t.name);if(r)return r.$get();throw`[Error] 变量'${t.name}' 未定义`}},Literal:t=>t.value,BlockStatement:(t,e)=>{var r=e.invasived?e:new Scope("block",e);for(const n of t.body){var s=evaluate(n,r);if(s===BREAK_SINGAL||s===CONTINUE_SINGAL||s===RETURN_SINGAL)return s}},EmptyStatement:()=>{},ExpressionStatement:(t,e)=>{evaluate(t.expression,e)},ReturnStatement:(t,e)=>(RETURN_SINGAL.result=t.argument?evaluate(t.argument,e):void 0,RETURN_SINGAL),BreakStatement:()=>BREAK_SINGAL,ContinueStatement:()=>CONTINUE_SINGAL,IfStatement:(t,e)=>evaluate(t.test,e)?evaluate(t.consequent,e):t.alternate?evaluate(t.alternate,e):void 0,ForStatement:(t,e)=>{var r=new Scope("loop",e);for(t.init&&evaluate(t.init,r);!t.test||evaluate(t.test,r);t.update&&evaluate(t.update,r)){var s=evaluate({type:"BlockStatement",body:t.body},r);if(s===BREAK_SINGAL)break;if(s!==CONTINUE_SINGAL&&s===RETURN_SINGAL)return s}},FunctionDeclaration:(t,e)=>{var r=evaluate_map.FunctionExpression(t,e),t=(t.id||{name:"anonymous"+anonymousId++})["name"];if(e.$const(t,r))return r;throw`[Error] ${t} 重复定义`},VariableDeclaration:(t,e)=>{var r=t.kind;for(const i of t.declarations){var s=i.id["name"],n=i.init?evaluate(i.init,e):void 0;if(!e.$declar(r,s,n))throw`[Error] ${s} 重复定义`}},ThisExpression:(t,e)=>{const r=e.$find("this");return r?r.$get():null},ArrayExpression:(t,e)=>t.elements.map(t=>evaluate(t,e)),ObjectExpression:(t,e)=>{const r={};for(const i of t.properties){var s=i.kind;let t;"Literal"===i.key.type?t=evaluate(i.key,e):"Identifier"===i.key.type&&(t=i.key.name);var n=evaluate(i.value,e);"init"===s?r[t]=n:"set"===s?Object.defineProperty(r,t,{set:n}):"get"===s&&Object.defineProperty(r,t,{get:n})}return r},FunctionExpression:(n,i)=>function(...e){const r=new Scope("function",i);r.invasived=!0;for(let t=0;t<n.params.length;t++){var s=n.params[t]["name"];r.$const(s,e[t])}r.$const("this",this),r.$const("arguments",arguments);var t=evaluate(n.body,r);if(t===RETURN_SINGAL)return t.result},UnaryExpression:(t,e)=>({"-":()=>-evaluate(t.argument,e),"+":()=>+evaluate(t.argument,e),"!":()=>!evaluate(t.argument,e),"~":()=>~evaluate(t.argument,e)})[t.operator](),UpdateExpression:(t,r)=>{const e=t["prefix"];let s;if("Identifier"===t.argument.type){var n=t.argument["name"];if(!(s=r.$find(n)))throw n+" 未定义"}else if("MemberExpression"===t.argument.type){n=t.argument;const i=evaluate(n.object,r);let e=n.computed?evaluate(n.property,r):n.property.name;s={$set(t){return i[e]=t,!0},$get(){return i[e]}}}return{"--":t=>(s.$set(t-1),e?--t:t--),"++":t=>(s.$set(t+1),e?++t:t++)}[t.operator](evaluate(t.argument,r))},BinaryExpression:(t,e)=>({"==":(t,e)=>t==e,"!=":(t,e)=>t!=e,"===":(t,e)=>t===e,"!==":(t,e)=>t!==e,"<":(t,e)=>t<e,"<=":(t,e)=>t<=e,">":(t,e)=>e<t,">=":(t,e)=>e<=t,"+":(t,e)=>t+e,"-":(t,e)=>t-e,"*":(t,e)=>t*e,"/":(t,e)=>t/e,"%":(t,e)=>t%e,"|":(t,e)=>t|e,"^":(t,e)=>t^e,"&":(t,e)=>t&e,in:(t,e)=>t in e,instanceof:(t,e)=>t instanceof e})[t.operator](evaluate(t.left,e),evaluate(t.right,e)),AssignmentExpression:(t,r)=>{let s;if("Identifier"===t.left.type){var n=t.left["name"],e=r.$find(n);if(!e)throw n+" 未定义";s=e}else{if("MemberExpression"!==t.left.type)throw"如果出现在这里，那就说明有问题了";{n=t.left;const i=evaluate(n.object,r);let e=n.computed?evaluate(n.property,r):n.property.name;s={$set(t){return i[e]=t,!0},$get(){return i[e]}}}}return{"=":t=>(s.$set(t),t),"+=":t=>(s.$set(s.$get()+t),s.$get()),"-=":t=>(s.$set(s.$get()-t),s.$get()),"*=":t=>(s.$set(s.$get()*t),s.$get()),"/=":t=>(s.$set(s.$get()/t),s.$get()),"%=":t=>(s.$set(s.$get()%t),s.$get()),"|=":t=>(s.$set(s.$get()|t),s.$get()),"^=":t=>(s.$set(s.$get()^t),s.$get()),"&=":t=>(s.$set(s.$get()&t),s.$get())}[t.operator](evaluate(t.right,r))},LogicalExpression:(t,e)=>({"||":()=>evaluate(t.left,e)||evaluate(t.right,e),"&&":()=>evaluate(t.left,e)&&evaluate(t.right,e)})[t.operator](),MemberExpression:(t,e)=>{var{object:t,property:r,computed:s}=t;return s?evaluate(t,e)[evaluate(r,e)]:evaluate(t,e)[r.name]},ConditionalExpression:(t,e)=>evaluate(t.test,e)?evaluate(t.consequent,e):evaluate(t.alternate,e),CallExpression:(t,e)=>{const r=evaluate(t.callee,e);var s=t.arguments.map(t=>evaluate(t,e));if("MemberExpression"===t.callee.type)return t=evaluate(t.callee.object,e),r.apply(t,s);{const n=e.$find("this");return r.apply(n?n.$get():null,s)}},NewExpression:(t,e)=>{const r=evaluate(t.callee,e);t=t.arguments.map(t=>evaluate(t,e));return new r(...t)},SequenceExpression:(t,e)=>{let r;for(const s of t.expressions)r=evaluate(s,e);return r}};class ScopeVar{value;kind;constructor(t,e){this.value=e,this.kind=t}$set(t){return"const"!==this.value&&(this.value=t,!0)}$get(){return this.value}}class Scope{content;parent;type;invasived;prefix="";constructor(t,e){this.type=t,this.parent=e||null,this.content={},this.invasived=!1}$find(t){var e=this.prefix+t;return this.content.hasOwnProperty(e)?this.content[e]:this.parent?this.parent.$find(t):null}$let(t,e){t=this.prefix+t;return!this.content[t]&&(this.content[t]=new ScopeVar("let",e),!0)}$const(t,e){t=this.prefix+t;return!this.content[t]&&(this.content[t]=new ScopeVar("const",e),!0)}$var(t,e){t=this.prefix+t;let r=this;for(;null!==r.parent&&"function"!==r.type;)r=r.parent;return!r.content[t]&&(this.content[t]=new ScopeVar("var",e),!0)}$declar(t,e,r){return{var:()=>this.$var(e,r),let:()=>this.$let(e,r),const:()=>this.$const(e,r)}[t]()}}let hasError=!1,runingCode="";const findErrorCode=t=>{if(!t)return code;let e=t,r=t;var s=runingCode.length-1;const n=[0,s];for(;-1!==e||r!==s;)-1!==e&&([59,19].includes(runingCode[e].charCodeAt())?(n[0]=e+1,e=-1):-1!==e&&e--),r!==s&&([59,19].includes(runingCode[r].charCodeAt())?(n[1]=r,r=s):r++);return runingCode.slice(n[0],n[1])+`
`+"^".repeat(n[1]-n[0])},evaluate=(e,t,r)=>{var s=t=>{if(!hasError&&t)throw hasError=!0,console.error("[naruse-parser] 错误代码\n"+findErrorCode(e.pos)),t&&console.error("[naruse-parser] 错误信息",t),new Error("[naruse-parser] 代码执行错误！")};const n=evaluate_map[e.type]||s();try{return n(e,t,r)}catch(t){s(t)}},default_api={console:console,setTimeout:setTimeout,setInterval:setInterval,clearTimeout:clearTimeout,clearInterval:clearInterval,encodeURI:encodeURI,encodeURIComponent:encodeURIComponent,decodeURI:decodeURI,decodeURIComponent:decodeURIComponent,Infinity:1/0,NaN:NaN,isFinite:isFinite,isNaN:isNaN,parseFloat:parseFloat,parseInt:parseInt,Object:Object,Boolean:Boolean,Error:Error,EvalError:EvalError,RangeError:RangeError,ReferenceError:ReferenceError,SyntaxError:SyntaxError,TypeError:TypeError,URIError:URIError,Number:Number,Math:Math,Date:Date,String:String,RegExp:RegExp,Array:Array,JSON:JSON,Promise:Promise,...babelPolyfill},run=(t,e={})=>{hasError=!1,runingCode=t;const r=new Scope("block");r.$const("this",void 0);for(const a of Object.getOwnPropertyNames(default_api))r.$const(a,default_api[a]);for(const o of Object.getOwnPropertyNames(e))r.$const(o,e[o]);var s={};r.$const("exports",s);const n=new Token(t),i=(n.scan(),new Parser(n.tokens));t=i.parse();return evaluate(t,r),s},createLogger=t=>{return{debug(){console.debug(`[${t}][debugger]`,...arguments)},warn(){console.warn(`[${t}][warn]`,...arguments)},info(){console.info(`[${t}][info]`,...arguments)},error(){console.error(`[${t}][error]`,...arguments)}}},logger=createLogger("naruse-h5"),reflectEventMap={click(t){return{type:"click",detail:{clientX:t.clientX,clientY:t.clientY,pageX:t.pageX,pageY:t.pageY},stopPropagation(){t.stopPropagation()}}},load(t){return{type:"load",detail:{width:t.target.width,height:t.target.height}}},focus(t){return{type:"foucs",detail:{value:t.target.value}}},blur(t){return{type:"blur",detail:{value:t.target.value}}},keydown(t){t.stopPropagation();var e=t.target["value"],t=t.keyCode||t.code;return{type:"keydown",detail:{value:e,cursor:e.length,keyCode:t}}},input(t){return{type:"input",detail:t.detail}}},reflectEventNameMap={click:"onClick",load:"onLoad",focus:"onFocus",blur:"onBlur",keydown:"onKeyDown",input:"onInput"},commonEventHander=function(t){const e=this.props[reflectEventNameMap[t.type]];if(e&&"function"==typeof e){var r=reflectEventMap[t.type];const s=reflectEventMap[t.type](t);s.timeStamp=(new Date).getTime(),r&&e(s)}};var cssStyle$2={"a-button":{display:"block",outline:"0",WebkitAppearance:"none",boxSizing:"border-box",padding:"0",textAlign:"center",fontSize:"18px",height:"47px",lineHeight:"47px",borderRadius:"2px",overflow:"hidden",textOverflow:"ellipsis",wordBreak:"break-word",whiteSpace:"nowrap",color:"#000",backgroundColor:"#fff",border:"1px solid #eee"},active:{backgroundColor:"#ddd",color:"rgba(0,0,0,.3)"},disabled:{color:"rgba(0,0,0,.6)",backgroundColor:"rgba(255,255,255,.6)"}};class Button extends React.Component{constructor(){super(),this.state={hover:!1,active:!1},this.touch=!1}onTouchStart(){var{disabled:t,hoverStartTime:e=20}=this.props;t||(this.touch=!0,setTimeout(()=>{this.setState({hover:!0})},e))}onTouchEnd(){var{disabled:t,hoverStayTime:e=70}=this.props;t||(this.touch=!1,setTimeout(()=>{this.touch||this.setState({hover:!1})},e))}onActiveStart(){var{disabled:t,hoverStartTime:e=20}=this.props;t||(this.touch=!0,setTimeout(()=>{this.setState({active:!0})},e))}onActiveEnd(){var{disabled:t,hoverStayTime:e=70}=this.props;t||(this.touch=!1,setTimeout(()=>{this.touch||this.setState({active:!1})},e))}render(){const{type:t,disabled:e,style:r,className:s,hoverStyle:n,activeStyle:i}=this.props;var{hover:a,active:o}=this.state,a={...cssStyle$2["a-button"],...t?cssStyle$2[t]:{},...a?n:{},...o?{...cssStyle$2.active,...i}:{}};return React.createElement("button",{onMouseEnter:this.onTouchStart.bind(this),onMouseLeave:this.onTouchEnd.bind(this),onMouseDown:this.onActiveStart.bind(this),onMouseUp:this.onActiveEnd.bind(this),style:{...a,...r},disabled:e,className:s,onClick:commonEventHander.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this)},this.props.children)}}function _extends(){return(_extends=Object.assign||function(t){for(var e=1;e<arguments.length;e++){var r,s=arguments[e];for(r in s)Object.prototype.hasOwnProperty.call(s,r)&&(t[r]=s[r])}return t}).apply(this,arguments)}class Checkbox extends React.Component{handleChange(t){t.stopPropagation(),this.props.onChange&&this.props.onChange({value:this.value})}render(){const{checked:t,name:e,color:r,value:s,disabled:n,...i}=this.props;return React.createElement("input",_extends({ref:t=>{t&&(this.inputEl=t,this.id&&t.setAttribute("id",this.id))},type:"checkbox",value:s,name:e,style:{color:r},checked:t,disabled:n,onChange:this.handleChange.bind(this)},i))}}var cssStyle$1={"img-empty":{opacity:"0"},naruseImg:{display:"inline-block",overflow:"hidden",position:"relative",fontSize:"0"},naruseImg__widthfix:{height:"100%"},scaletofill:{objectFit:"contain",width:"100%",height:"100%"},aspectfit:{objectFit:"contain",width:"100%",height:"100%"},aspectfill:{objectFit:"cover",width:"100%",height:"100%"},widthfix:{width:"100%"},top:{width:"100%"},bottom:{width:"100%",position:"absolute",bottom:"0"},left:{height:"100%"},right:{position:"absolute",height:"100%",right:"0"},topright:{position:"absolute",right:"0"},bottomleft:{position:"absolute",bottom:"0"},bottomright:{position:"absolute",right:"0",bottom:"0"}};class Image extends React.Component{constructor(t){super(t),this.state={isLoaded:!1},this.imageOnLoad=this.imageOnLoad.bind(this),this.observer={},this.imgRef=null}componentDidMount(){this.props.lazyLoad&&(this.observer=new IntersectionObserver(t=>{t[t.length-1].isIntersecting&&this.setState({isLoaded:!0},()=>{this.imgRef.src=this.props.src})},{rootMargin:"300px 0px"}),this.observer.observe(this.imgRef))}componentWillUnmount(){this.observer.disconnect&&this.observer.disconnect()}imageOnLoad=commonEventHander.bind(this);render(){const{className:t,src:e,style:r={},mode:s,onError:n,imgProps:i}=this.props;var a={...cssStyle$1.naruseImg,..."widthFix"===s?cssStyle$1.naruseImg__widthfix:{}},o=cssStyle$1[(s||"scaleToFill").toLowerCase().replace(/\s/g,"")];return React.createElement("div",{onClick:commonEventHander.bind(this),className:t,style:{...a,...r}},React.createElement("img",_extends({ref:t=>this.imgRef=t,style:o,src:e,onLoad:this.imageOnLoad,onError:n},i)))}}const getTrueType=function(t,e,r){if("search"===e&&(t="search"),void 0===(t=r?"password":t))return"text";if(t)return t="digit"===t?"number":t;throw new Error("unexpected type")},fixControlledValue=function(t){return t??""};class Input extends React.Component{constructor(){super(),this.inputRef=null,this.isOnComposition=!1,this.onInputExcuted=!1,this.el={},this.state={_value:""}}componentDidMount(){"file"===this.props.type&&(this.fileListener=t=>{this.props.onInput&&this.props.onInput(t)},this.inputRef?.addEventListener("change",this.fileListener)),Object.defineProperty(this.el,"value",{get:()=>this.inputRef?.value,set:t=>{this.setState({_value:t})},configurable:!0}),setTimeout(()=>this.props.focus&&this.inputRef?.focus())}handleInput(t){t.stopPropagation();var{type:e,maxlength:r,confirmType:s,password:n}=this.props;let i=t.target["value"];"number"===getTrueType(e,s,n)&&i&&r<=i.length&&(i=i.substring(0,r),t.target.value=i),this._value=i,this.setState({_value:i}),commonEventHander.call(this,{type:"input",detail:{value:i,cursor:i.length}})}handleFocus=commonEventHander.bind(this);handleBlur=commonEventHander.bind(this);handleChange=commonEventHander.bind(this);handleKeyDown=t=>{var e=t.target["value"],r=t.keyCode||t.code;commonEventHander.call(this,t),13===r&&this.props.onConfirm&&this.props.onConfirm({value:e})};render(){const{type:t,password:e,placeholder:r,disabled:s,maxlength:n,confirmType:i,name:a,className:o,value:c,controlled:h}=this.props;var p=this.state["_value"];return React.createElement("input",{ref:t=>{this.inputRef=t},className:o,value:fixControlledValue(h?c:c??p),type:getTrueType(t,i,e),placeholder:r,disabled:s,maxLength:n,name:a,onInput:this.handleInput.bind(this),onFocus:this.handleFocus.bind(this),onBlur:this.handleBlur.bind(this),onChange:this.handleChange.bind(this),onKeyDown:this.handleKeyDown.bind(this)})}}var cssStyle={text:{MozUserSelect:"none",WebkitUserSelect:"none",MsUserSelect:"none",userSelect:"none"},textSelectable:{MozUserSelect:"text",WebkitUserSelect:"text",MsUserSelect:"text",userSelect:"text"}};class Text extends React.Component{state={hover:!1};onTouchStart(){var{disabled:t,hoverStartTime:e=20}=this.props;t||(this.touch=!0,setTimeout(()=>{this.setState({hover:!0})},e))}onTouchEnd(){var{disabled:t,hoverStayTime:e=70}=this.props;t||(this.touch=!1,setTimeout(()=>{this.touch||this.setState({hover:!1})},e))}render(){const{className:t,selectable:e=!1,style:r,hoverStyle:s}=this.props;var n=this.state["hover"],n={...n?s:{},...cssStyle.text,...e?cssStyle.textSelectable:{},...r};return React.createElement("span",{onMouseEnter:this.onTouchStart.bind(this),onMouseLeave:this.onTouchEnd.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this),style:n,className:t,onClick:commonEventHander.bind(this)},this.props.children)}}class View extends React.Component{state={hover:!1};onTouchStart(){var{disabled:t,hoverStartTime:e=20}=this.props;t||(this.touch=!0,setTimeout(()=>{this.setState({hover:!0})},e))}onTouchEnd(){var{disabled:t,hoverStayTime:e=70}=this.props;t||(this.touch=!1,setTimeout(()=>{this.touch||this.setState({hover:!1})},e))}render(){const{className:t,style:e,hoverStyle:r}=this.props;var s=this.state["hover"],s={...s?r:{},...e};return React.createElement("div",{onMouseEnter:this.onTouchStart.bind(this),onMouseLeave:this.onTouchEnd.bind(this),onTouchStart:this.onTouchStart.bind(this),onTouchEnd:this.onTouchEnd.bind(this),className:t,style:s,onClick:commonEventHander.bind(this)},this.props.children)}}const componentReflectMap={button:Button,checkbox:Checkbox,image:Image,input:Input,text:Text,view:View},naruseCreateElement=(t,e,...r)=>{var s;return transformRpx(e),"string"==typeof t?(s=componentReflectMap[t])?React.createElement(s,e,...r):(logger.warn("不支持的组件类型",t),naruseCreateElement("view",null,"不支持的组件类型")):t.prototype instanceof React.Component?React.createElement(t,e,...r):"function"==typeof t?(e.children=r,t(e)):void logger.warn("不支持的组件类型",t)},rpxReg=/(\d+)\s?rpx/g,parsePx=r=>{if("string"!=typeof r)return r;const t=r.match(rpxReg);return t&&t.forEach(t=>{var e=parseFloat(t);r=r.replace(t,(e/2*1.4).toFixed(1)+"px")}),r},transformRpx=(t={})=>{if(t){const e=t["style"];if(e&&"object"==typeof e)for(const r in e)e[r]=parsePx(e[r])}};class MethodHandler{constructor({name:t,success:e,fail:r,complete:s}){this.methodName=t,this.__success=e,this.__fail=r,this.__complete=s}success(t={},e=Promise.resolve.bind(Promise)){return t.errMsg||(t.errMsg=this.methodName+":ok"),"function"==typeof this.__success&&this.__success(t),"function"==typeof this.__complete&&this.__complete(t),e(t)}fail(t={},e=Promise.reject.bind(Promise)){return t.errMsg?t.errMsg=this.methodName+":fail "+t.errMsg:t.errMsg=this.methodName+":fail",logger.error(t.errMsg),"function"==typeof this.__fail&&this.__fail(t),"function"==typeof this.__complete&&this.__complete(t),e(t)}}const getItem=function(t){let e;try{e=JSON.parse(localStorage.getItem(t)||"")}catch(t){}return e&&"object"==typeof e&&e.hasOwnProperty("data")?{result:!0,data:e.data}:{result:!1}},setStorageSync=({key:e,data:r=""})=>{if("string"!=typeof e)logger.error("setStorageSync:fail key must be string");else{let t={};t="symbol"==typeof r?{data:""}:{data:r},localStorage.setItem(e,JSON.stringify(t))}},setStorage=t=>{if("object"!=typeof t)return e={errMsg:"setStorage:fail must has a object"},logger.error(e.errMsg),Promise.reject(e);var{key:e,success:t,fail:r,complete:s}=t;const n=new MethodHandler({name:"setStorage",success:t,fail:r,complete:s});return"string"!=typeof e?n.fail({errMsg:"setStorage:fail key must be string"}):(setStorageSync(e),n.success())},removeStorageSync=({key:t})=>{"string"!=typeof t?logger.error("removeStorageSync:fail key must be string"):localStorage.removeItem(t)},removeStorage=t=>{if("object"!=typeof t)return e={errMsg:"removeStorage:fail must has a object"},logger.error(e.errMsg),Promise.reject(e);var{key:e,success:t,fail:r,complete:s}=t;const n=new MethodHandler({name:"removeStorage",success:t,fail:r,complete:s});if("string"==typeof e)return removeStorageSync(e),n.success();logger.error("removeStorage:fail key must be string")},getStorageSync=({key:t})=>{{if("string"==typeof t)return(t=getItem(t)).result?t.data:"";logger.error("getStorageSync:fail key must be string")}},getStorageInfoSync=()=>{return{keys:Object.keys(localStorage),limitSize:NaN,currentSize:NaN}},getStorageInfo=({success:t,fail:e,complete:r}={})=>{const s=new MethodHandler({name:"getStorageInfo",success:t,fail:e,complete:r});return s.success(getStorageInfoSync())},getStorage=t=>{if("object"!=typeof t)return e={errMsg:"removeStorage:fail must has a object"},logger.error(e.errMsg),Promise.reject(e);var{key:e,success:t,fail:r,complete:s}=t;const n=new MethodHandler({name:"getStorage",success:t,fail:r,complete:s});return"string"!=typeof e?n.fail({errMsg:"getStorage:fail key must be string"}):void 0},clearStorageSync=()=>{localStorage.clear()},clearStorage=({success:t,fail:e,complete:r}={})=>{const s=new MethodHandler({name:"clearStorage",success:t,fail:e,complete:r});return clearStorageSync(),s.success()};var Storage=Object.freeze({__proto__:null,setStorageSync:setStorageSync,setStorage:setStorage,removeStorageSync:removeStorageSync,removeStorage:removeStorage,getStorageSync:getStorageSync,getStorageInfoSync:getStorageInfoSync,getStorageInfo:getStorageInfo,getStorage:getStorage,clearStorageSync:clearStorageSync,clearStorage:clearStorage});const redirectTo=({url:t})=>{window.location.href=t},navigateTo=({url:t})=>{window.open(t)};var Route=Object.freeze({__proto__:null,redirectTo:redirectTo,navigateTo:navigateTo});const Naruse={...Storage,...Route,Component:React.Component,env:{USER_DATA_PATH:"",clientName:"H5",clientVersion:"0.0.1",language:"zh-Hans",platform:"H5"},getSystemInfoSync:()=>({platform:"PC"})},jsEngineEnv={h:naruseCreateElement,Naruse:Naruse,my:Naruse};class ReactMiddleware extends React.Component{constructor(t){super(t);const e=run(t.code,{...t.env||{},...jsEngineEnv});e.default?this.compilerComponent=e.default:((t=function(...t){const r=this;React.Component.apply(this,t),e.constructor.call(this),Object.entries(e).forEach(([t,e])=>{"constructor"!==t&&(r[t]="function"==typeof e?e.bind(r):e)})}).prototype=Object.create(React.Component.prototype),Object.assign(t.prototype,{constructor:t}),this.compilerComponent=t)}render(){return React.createElement(this.compilerComponent,null)}}export{ReactMiddleware as default};
